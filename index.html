<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GutLogix - IBS Tracker</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<style>
  .hour-slot { border-bottom: 1px solid #dee2e6; padding: 8px; }
  .entry { padding: 2px 6px; margin: 2px 0; border-radius: 4px; font-size: 0.875rem; }
  .food-entry { background-color: #fff3cd; }
  .symptom-entry { background-color: #f8d7da; }
</style>
</head>
<body class="bg-light">

<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3">IBS Food & Symptom Tracker</h1>
    <button id="viewReport" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reportModal">View Report</button>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-2">
    <button id="prevDay" class="btn btn-outline-secondary">&lt; Previous</button>
    <span id="currentDate" class="fw-bold"></span>
    <button id="nextDay" class="btn btn-outline-secondary">Next &gt;</button>
  </div>

  <div id="diaryGrid" class="border bg-white rounded">
    <!-- Hour slots generated here -->
  </div>
</div>

<!-- Food Modal -->
<div class="modal fade" id="foodModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Food</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="foodForm">
          <div class="mb-3">
            <label class="form-label">Select Food</label>
            <select id="foodSelect" class="form-select">
              <!-- Options populated dynamically -->
            </select>
          </div>
          <div id="newFoodFields" class="d-none">
            <div class="mb-3">
              <label class="form-label">Food Name</label>
              <input type="text" id="newFoodName" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">Allergens (comma separated)</label>
              <input type="text" id="newFoodAllergens" class="form-control">
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Quantity</label>
            <input type="text" id="foodQty" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Time</label>
            <input type="time" id="foodTime" class="form-control">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="saveFood" class="btn btn-success">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Symptom Modal -->
<div class="modal fade" id="symptomModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Symptom</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="symptomForm">
          <div class="mb-3">
            <label class="form-label">Symptom</label>
            <select id="symptomSelect" class="form-select">
              <option value="">--Select--</option>
            </select>
            <input type="text" id="customSymptom" placeholder="Or add custom symptom" class="form-control mt-2">
          </div>
          <div class="mb-3">
            <label class="form-label">Severity (1-10)</label>
            <input type="number" id="symptomSeverity" min="1" max="10" class="form-control" value="5">
          </div>
          <div class="mb-3">
            <label class="form-label">Frequency</label>
            <select id="symptomFrequency" class="form-select">
              <option value="once">Once</option>
              <option value="hourly">Hourly</option>
              <option value="constant">Constant</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Time</label>
            <input type="time" id="symptomTime" class="form-control">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="saveSymptom" class="btn btn-success">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Correlation Report</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="reportContent">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
$(function(){
  const predefinedSymptoms = [
    "Abdominal pain", "Bloating", "Diarrhea", "Constipation", "Gas", "Urgency", "Fatigue"
  ];

  let state = {
    foods: [],
    symptoms: [],
    diary: [],
    currentDate: new Date().toISOString().split('T')[0],
    nextFoodId: 1
  };

  function loadState(){
    const saved = localStorage.getItem('ibsTracker');
    if(saved) state = JSON.parse(saved);
  }

  function saveState(){
    localStorage.setItem('ibsTracker', JSON.stringify(state));
  }

  function populateFoodSelect(){
    const select = $('#foodSelect').empty();
    select.append('<option value="">--Select Food--</option>');
    state.foods.forEach(f=> select.append(`<option value="${f.id}">${f.name}</option>`));
    select.append('<option value="new">+ Add New Food</option>');
  }

  function populateSymptomSelect(){
    const select = $('#symptomSelect').empty().append('<option value="">--Select--</option>');
    predefinedSymptoms.forEach(s=> select.append(`<option value="${s}">${s}</option>`));
    state.symptoms.forEach(s=>{
      if(!predefinedSymptoms.includes(s.name)) select.append(`<option value="${s.name}">${s.name}</option>`);
    });
  }

  function renderDiary(){
    $('#currentDate').text(state.currentDate);
    $('#diaryGrid').empty();
    for(let h=0; h<24; h++){
      const hourStr = h.toString().padStart(2,'0') + ":00";
      const slot = $(`<div class="hour-slot row align-items-start">
        <div class="col-2 fw-bold">${hourStr}</div>
        <div class="col-7 entries"></div>
        <div class="col-3 text-end">
          <button class="btn btn-sm btn-warning addFoodBtn">Add Food</button>
          <button class="btn btn-sm btn-danger addSymptomBtn">Add Symptom</button>
        </div>
      </div>`);
      const entries = state.diary.filter(e => e.datetime.startsWith(state.currentDate) && new Date(e.datetime).getHours() === h);
      entries.forEach(e=>{
        let text = '';
        if(e.type==='food'){
          const f = state.foods.find(f=>f.id===e.foodId);
          text = f ? `${f.name} (${e.quantity})` : `Unknown food (${e.quantity})`;
        } else {
          text = `${e.name} (Severity:${e.severity})`;
        }
        const div = $('<div class="entry"></div>').text(text);
        div.addClass(e.type==='food'?'food-entry':'symptom-entry');
        slot.find('.entries').append(div);
      });
      slot.find('.addFoodBtn').click(()=> {
        $('#foodTime').val(hourStr);
        $('#foodSelect').val('');
        $('#newFoodFields').addClass('d-none');
        $('#foodQty').val('');
        $('#foodModal').modal('show');
      });
      slot.find('.addSymptomBtn').click(()=> {
        $('#symptomTime').val(hourStr);
        $('#symptomSelect').val('');
        $('#customSymptom').val('');
        $('#symptomSeverity').val(5);
        $('#symptomFrequency').val('once');
        $('#symptomModal').modal('show');
      });
      $('#diaryGrid').append(slot);
    }
  }

  $('#foodSelect').change(function(){
    if($(this).val() === 'new'){
      $('#newFoodFields').removeClass('d-none');
    } else {
      $('#newFoodFields').addClass('d-none');
    }
  });

  $('#saveFood').click(()=>{
    const selected = $('#foodSelect').val();
    let foodId;
    if(selected === 'new'){
      const name = $('#newFoodName').val().trim();
      const allergens = $('#newFoodAllergens').val().split(',').map(a=>a.trim()).filter(a=>a);
      if(!name) return alert("Food name required");
      foodId = state.nextFoodId++;
      state.foods.push({id: foodId, name, allergens});
    } else {
      foodId = parseInt(selected);
    }
    const qty = $('#foodQty').val().trim();
    const time = $('#foodTime').val();
    if(!time) return alert("Time required");
    state.diary.push({datetime:`${state.currentDate}T${time}`, type:'food', foodId, quantity:qty});
    saveState();
    $('#foodModal').modal('hide');
    renderDiary();
    populateFoodSelect();
  });

  $('#saveSymptom').click(()=>{
    let name = $('#symptomSelect').val();
    const custom = $('#customSymptom').val().trim();
    if(custom) name = custom;
    if(!name) return alert("Symptom required");
    const severity = parseInt($('#symptomSeverity').val()) || 5;
    const frequency = $('#symptomFrequency').val();
    const time = $('#symptomTime').val();
    if(!time) return alert("Time required");
    state.diary.push({datetime:`${state.currentDate}T${time}`, type:'symptom', name, severity, frequency});
    if(custom && !state.symptoms.find(s=>s.name.toLowerCase()===custom.toLowerCase())) state.symptoms.push({name: custom, predefined:false});
    saveState();
    $('#symptomModal').modal('hide');
    renderDiary();
    populateSymptomSelect();
  });

  $('#prevDay').click(()=>{
    const d = new Date(state.currentDate);
    d.setDate(d.getDate()-1);
    state.currentDate = d.toISOString().split('T')[0];
    renderDiary();
  });

  $('#nextDay').click(()=>{
    const d = new Date(state.currentDate);
    d.setDate(d.getDate()+1);
    state.currentDate = d.toISOString().split('T')[0];
    renderDiary();
  });

  function generateReport(){
    const report = {};
    state.foods.forEach(f=>{
      const foodEntries = state.diary.filter(d=>d.type==='food' && d.foodId===f.id);
      if(foodEntries.length===0) return;
      const relatedSymptoms = {};
      foodEntries.forEach(fe=>{
        const feTime = new Date(fe.datetime).getTime();
        state.diary.filter(d=>d.type==='symptom').forEach(se=>{
          const seTime = new Date(se.datetime).getTime();
          if(seTime >= feTime && seTime <= feTime + 6*3600*1000){
            relatedSymptoms[se.name] = (relatedSymptoms[se.name]||0)+1;
          }
        });
      });
      if(Object.keys(relatedSymptoms).length>0) report[f.name] = relatedSymptoms;
    });
    let html = '';
    if(Object.keys(report).length===0) html='<p>No correlations found yet.</p>';
    else {
      for(const food in report){
        html+=`<h6 class="mt-3">${food}</h6><ul>`;
        for(const symptom in report[food]){
          html+=`<li>${symptom}: ${report[food][symptom]} occurrences</li>`;
        }
        html+='</ul>';
      }
    }
    $('#reportContent').html(html);
  }

  $('#reportModal').on('show.bs.modal', generateReport);

  loadState();
  renderDiary();
  populateFoodSelect();
  populateSymptomSelect();
});
</script>

</body>
</html>
